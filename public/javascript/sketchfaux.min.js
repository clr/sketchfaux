
Function.prototype.method=function(name,lambda){this.prototype[name]=lambda;return this;};Function.method('inherits',function(parent){var d={};var p=(this.prototype=new parent());this.method('_super',function _super(name){if(!(name in d)){d[name]=0;}
var f,r,t=d[name];var v=parent.prototype;if(t){while(t){v=v.constructor.prototype;t-=1;}
f=v[name];}else{f=p[name];if(f==this[name]){f=v[name];}}
d[name]+=1;r=f.apply(this,Array.prototype.slice.apply(arguments,[1]));d[name]-=1;return r;});return this;});Function.method('swiss',function(parent){for(var i=1;i<arguments.length;i++){var name=arguments[i];this.prototype[name]=parent.prototype[name];}
return this;});Function.prototype.bind=function(object){var method=this;var temp=function(){return method.apply(object,arguments);};return temp;}
String.method('toCamelCase',function(){if(this.length<1){return this;}
var newString='';var parts=this.split(/[^a-zA-Z0-9]/);for(var i=0;i<parts.length;i++){var part=parts[i];if(part.length>0){newString+=(part[0].toUpperCase()+part.slice(1));}}
return newString;});DummyPepperClass=function(){this.dummyAttr=null;};DummyPepperClass.method('getDummyAttr',function(){return this.dummyAttr;});DummyPepperClass.method('setDummyAttr',function(newValue){this.dummyAttr=newValue;return this;});Array.method('hasElement',function(element){for(var i=0;i<this.length;i++){if(element==this[i]){return true;}}
return false;});NodeList.prototype.hasElement=function(element){for(var i=0;i<this.length;i++){if(element==this.item(i)){return true;}}
return false;};Array.method('first',function(){return this[0];});Array.method('last',function(){return this[this.length-1];});notNull=function(){for(var i=0;i<arguments.length;i++){var value=arguments[i];if(value!=null){return value;}}};Event=function(species){this.species=species;};Event.method('trigger',function(domElement){if(!domElement){alert('Cannot trigger an event into the ether; must be attached to a DOM element.');}
if(document.createEvent){event=document.createEvent('MouseEvents');}
event.initMouseEvent(this.species,true,true,document.defaultView,1,0,0,0,0,false,false,false,false,0,null);domElement.dispatchEvent(event);});Interface=function(context,url){this.context=context;this.url=url;this.data={l:[]};this.pencilOnCanvas=false;this.currentLine=null;this.generateCanvas().generateColorPicker().generateOpacityPicker().generateSizePicker().generateSaver().generateButtons().generateStyle().generatePlayer().generateDataFromUrl();var that=this;this.getCanvasHolder().mousedown(function(mouseEvent){var coordinates=that.normalizeCoordinates(mouseEvent,this);that.stop.trigger('click');that.pencilDown();that.createLine();that.data.l.push(that.getCurrentLine());that.currentLine.p.push([coordinates[0],coordinates[1]]);that.getCanvas().createLine([coordinates[0],coordinates[1]],{diameter:that.getCurrentLine().s.d,color:that.getCurrentLine().s.c,opacity:that.getCurrentLine().s.o});that.undo.removeClass('disabled');that.saver.removeClass('disabled');});this.getCanvasHolder().mousemove(function(mouseEvent){if(that.isPencilOnCanvas()){var coordinates=that.normalizeCoordinates(mouseEvent,this);that.getCurrentLine().p.push([coordinates[0],coordinates[1]]);that.getCanvas().createSegment([coordinates[0],coordinates[1]]);}});this.getCanvasHolder().mouseup(function(mouseEvent){that.pencilUp();});return this;};Interface.method('getContext',function(){return this.context;});Interface.method('getData',function(){return this.data;});Interface.method('getCurrentLine',function(){return this.currentLine;});Interface.method('pencilDown',function(){this.pencilOnCanvas=true;});Interface.method('pencilUp',function(){this.pencilOnCanvas=false;});Interface.method('isPencilOnCanvas',function(){return this.pencilOnCanvas;});Interface.method('createLine',function(){this.currentLine={s:this.getStyle().getStyle(),p:[]};return this;});Interface.method('undoLine',function(){if(this.getCurrentLine()==this.data.l.last()){this.data.l.pop();this.getCanvas().clearScratchCanvasElement();}});Interface.method('normalizeCoordinates',function(mouseEvent,element){var offset=$(element).offset();return[(mouseEvent.pageX-offset.left-4),(mouseEvent.pageY-offset.top-4)];});Interface.method('generateCanvas',function(){this.canvasHolder=$("<div><canvas></canvas></div>");this.canvasHolder.addClass('canvas_holder');this.canvas=new Canvas(this.canvasHolder.find('> canvas')[0]);this.canvasHolder.appendTo(this.getContext());return this;});Interface.method('getCanvasHolder',function(){return this.canvasHolder;});Interface.method('getCanvas',function(){return this.canvas;});Interface.method('generateColorPicker',function(){this.colorPicker=$("<div></div>");this.colorPicker.addClass('color_picker_holder');$(this.colorPicker).ColorPicker({flat:true});$(this.getContext()).append(this.colorPicker);return this;});Interface.method('getColorPicker',function(){return this.colorPicker;});Interface.method('generateSizePicker',function(){this.sizePicker=$("<div><div><span>SIZE</span><div></div></div></div>");this.sizePicker.addClass('size_picker_holder');this.sizePicker.find('> div').addClass('generic_slider');this.size=this.sizePicker.find('> div > div')[0];$(this.size).slider({min:1,max:100,value:4});$(this.getContext()).append(this.sizePicker);return this;});Interface.method('getSizePicker',function(){return this.sizePicker;});Interface.method('generateOpacityPicker',function(){this.opacityPicker=$("<div><div><span>OPACITY</span><div></div></div></div>");this.opacityPicker.addClass('opacity_picker_holder');this.opacityPicker.find('> div').addClass('generic_slider');this.opacity=this.opacityPicker.find('> div > div')[0];$(this.opacity).slider({min:0,max:100,value:100});$(this.getContext()).append(this.opacityPicker);return this;});Interface.method('getOpacityPicker',function(){return this.opacityPicker;});Interface.method('generateButtons',function(){var that=this;this.toolbar=$("<div></div>");this.toolbar.addClass('button_toolbar').appendTo(this.getContext());this.replay=$("<button>REPLAY</button>");this.replay.addClass('generic_button').addClass('replay').appendTo(this.toolbar).click(function(){that.getPlayer().replay();that.stop.removeClass('disabled');return false;});this.stop=$("<button>STOP</button>");this.stop.addClass('generic_button').addClass('stop').addClass('disabled').appendTo(this.toolbar).click(function(){that.getPlayer().stop();that.stop.addClass('disabled');return false;});this.speedPicker=$("<div><div><span>PLAYBACK SPEED</span><div></div></div></div>");this.speedPicker.addClass('speed_picker_holder');this.speedPicker.find('> div').addClass('thin_slider');this.speed=this.speedPicker.find('> div > div')[0];$(this.speed).slider({min:0,max:150,value:150});$(this.toolbar).append(this.speedPicker);this.undo=$("<button>UNDO</button>");this.undo.addClass('generic_button').addClass('undo').addClass('disabled').appendTo(this.toolbar).click(function(){that.undoLine();that.undo.addClass('disabled');return false;});return this;});Interface.method('generateSaver',function(){var that=this;this.saverHolder=$("<div><span>save this sketch as:</span><input type='text' name='name' id='sketch_name' /></div>");this.saverHolder.addClass('saver_holder').appendTo(this.getContext());this.saver=$("<button>SAVE</button>");this.saver.addClass('generic_button').appendTo(this.saverHolder).click(function(){that.save();that.saver.addClass('disabled');return false;});return this;});Interface.method('getSpeed',function(){return 150-parseInt($(this.speed).slider('value'));});Interface.method('generateStyle',function(){this.style=new Style(this.getColorPicker(),this.opacity,this.size);return this;});Interface.method('getStyle',function(){return this.style;});Interface.method('generatePlayer',function(url){this.player=new Player(this);return this;});Interface.method('getPlayer',function(){return this.player;});Interface.method('save',function(){that=this;$.ajax({type:"POST",url:'/',data:{'sketch[name]':$("#sketch_name")[0].value,'sketch[data]':$.toJSON(that.getData()),'sketch[thumbnail]':that.getCanvas().getThumbnail()},success:function(json){alert('Sketch has been saved.');},});});Interface.method('generateDataFromUrl',function(){if(this.hasUrl()){that=this;$.ajax({type:"GET",url:that.url,success:function(json){that.data=json;that.replay.trigger('click');},dataFilter:function(data){if((typeof(JSON)!=='undefined')&&(typeof(JSON.parse)==='function')){return JSON.parse(data);}else{return $.secureEvalJSON(data);}}});}});Interface.method('hasUrl',function(){if((this.url!=null)&&(this.url.length>0)){return true;}else{return false;}});(function($){$.fn.extend({sketchfaux:function(playback){this.each(function(){new Interface(this,playback);});}});})(jQuery)
Style=function(colorPicker,opacityPicker,sizePicker){this.colorPicker=colorPicker;this.opacityPicker=opacityPicker;this.sizePicker=sizePicker;};Style.method('getColor',function(){return'#'+$(this.colorPicker).ColorPickerGetColor();});Style.method('getOpacity',function(){return((0.0+$(this.opacityPicker).slider('value'))/100);});Style.method('getSize',function(){return parseInt($(this.sizePicker).slider('value'));});Style.method('getStyle',function(){return{c:this.getColor(),o:this.getOpacity(),d:this.getSize()};});Player=function(interface){this.interface=interface;this.i=0;this.j=0;this.timeout=null;}
Player.method('getData',function(){return this.getInterface().getData();});Player.method('play',function(){var that=this;this.timeout=setTimeout(function(){that.frameForward()},this.getSpeed());});Player.method('frameForward',function(){var data=this.getData().l;if(this.j>=data[this.i].p.length){this.i++;this.j=0;}
if(this.i>=data.length){this.getInterface().stop.addClass('disabled');return;}
if(this.j==0){var line=data[this.i];var point=data[this.i].p[this.j];this.getInterface().getCanvas().createLine(point,{diameter:line.s.d,color:line.s.c,opacity:line.s.o});}else{var point=data[this.i].p[this.j];this.getInterface().getCanvas().createSegment(point);}
this.j++;this.play();});Player.method('replay',function(){this.getInterface().getCanvas().cleanSlate();this.i=0;this.j=0;this.play();});Player.method('stop',function(){window.clearTimeout(this.timeout);});Player.method('getInterface',function(){return this.interface;});Player.method('getSpeed',function(){return this.getInterface().getSpeed();});Canvas=function(canvasElement){this.canvasElement=canvasElement;var width=parseInt($(this.canvasElement).css('width'));var height=parseInt($(this.canvasElement).css('height'));this.width=(isNaN(width)?60:width);this.height=(isNaN(height)?60:height);this.scratchCanvasElement=null;this.colorPicker=document.getElementById('color_picker');this.cleanSlate();return this;}
Canvas.method('createLine',function(coordinates,options){options.diameter=notNull(options.diameter,2);options.color=notNull(options.color,'#000000');options.opacity=notNull(options.opacity,1.0);this.collapseScratchCanvasElement();this.generateScratchCanvasElement(options.opacity);var context=this.getScratchCanvasElement().getContext('2d');context.lineCap='round';context.lineJoin='round';context.lineWidth=options.diameter;context.strokeStyle=options.color;context.globalAlpha=1.0;context.stroke();context.beginPath();context.lineTo(coordinates[0],coordinates[1]);context.stroke();});Canvas.method('createSegment',function(coordinates){var context=this.getScratchCanvasElement().getContext('2d');context.lineTo(coordinates[0],coordinates[1]);context.stroke();});Canvas.method('getCanvasElement',function(){return this.canvasElement;});Canvas.method('getOffset',function(){if(this.getCanvasElement().parentNode.boxObject){return[this.getCanvasElement().parentNode.boxObject.x,this.getCanvasElement().parentNode.boxObject.y];}else{return[this.getCanvasElement().parentNode.offsetLeft,this.getCanvasElement().parentNode.offsetTop];}});Canvas.method('collapseScratchCanvasElement',function(){if(this.getScratchCanvasElement()!=null){var scratchContext=this.getScratchCanvasElement().getContext('2d');var imageData=scratchContext.getImageData(0,0,this.width,this.height);var pixels=imageData.data;var opacity=this.getScratchCanvasElement().style.opacity;for(var i=0,n=pixels.length;i<n;i+=4){pixels[i+3]=parseInt(opacity*pixels[i+3]);}
scratchContext.putImageData(imageData,0,0);this.getCanvasElement().getContext('2d').drawImage(this.getScratchCanvasElement(),0,0);this.clearScratchCanvasElement();}});Canvas.method('clearScratchCanvasElement',function(){if(this.getCanvasElement().parentNode.childNodes.hasElement(this.getScratchCanvasElement())){this.getCanvasElement().parentNode.removeChild(this.getScratchCanvasElement());}
this.setScratchCanvasElement(null);});Canvas.method('generateScratchCanvasElement',function(opacity){var newCanvasElement=$("<canvas></canvas>");newCanvasElement.appendTo(this.getCanvasElement().parentNode);newCanvasElement.attr('width',this.width);newCanvasElement.attr('height',this.height);newCanvasElement.css('opacity',opacity);newCanvasElement.css('z-index','2');this.scratchCanvasElement=newCanvasElement[0];});Canvas.method('setScratchCanvasElement',function(scratchCanvasElement){this.scratchCanvasElement=scratchCanvasElement;return this;});Canvas.method('getScratchCanvasElement',function(){return this.scratchCanvasElement;});Canvas.method('getThumbnail',function(){return this.getCanvasElement().toDataURL().replace(/^data:image\/png;base64,/,'');});Canvas.method('cleanSlate',function(){this.getCanvasElement().setAttribute('width',this.width);this.getCanvasElement().setAttribute('height',this.height);this.getCanvasElement().setAttribute('style','z-index:1');this.clearScratchCanvasElement();context=this.getCanvasElement().getContext('2d');context.clearRect(0,0,this.width,this.height);context.fillStyle="white";context.fillRect(0,0,this.width,this.height);});